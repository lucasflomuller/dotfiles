---
# Common tasks that run on all platforms

- name: "🔧 Ensure ~/bin directory exists"
  file:
    path: "{{ ansible_user_dir }}/bin"
    state: directory
    mode: '0755'

- name: "🔧 Add ~/bin to PATH in shell profiles"
  lineinfile:
    path: "{{ item }}"
    line: 'export PATH="$HOME/bin:$PATH"'
    create: yes
    state: present
  loop:
    - "{{ ansible_user_dir }}/.profile"
    - "{{ ansible_user_dir }}/.bashrc"
  when: ansible_system != "Darwin"

- name: "🔧 Add ~/bin to PATH in macOS shell profiles"
  lineinfile:
    path: "{{ item }}"
    line: 'export PATH="$HOME/bin:$PATH"'
    create: yes
    state: present
  loop:
    - "{{ ansible_user_dir }}/.zprofile"
    - "{{ ansible_user_dir }}/.zshrc"
  when: ansible_system == "Darwin"

- name: "🔍 Check if chezmoi is already installed"
  command: which chezmoi
  register: chezmoi_check
  failed_when: false
  changed_when: false

- name: "📥 Install chezmoi (macOS via Homebrew)"
  homebrew:
    name: chezmoi
    state: present
  when: ansible_system == "Darwin" and chezmoi_check.rc != 0

- name: "📥 Install chezmoi (Arch Linux)"
  package:
    name: chezmoi
    state: present
  become: yes
  when: ansible_pkg_mgr == "pacman" and chezmoi_check.rc != 0

- name: "📥 Install chezmoi (fallback - curl script)"
  shell: sh -c "$(curl -fsLS get.chezmoi.io)"
  when: ansible_system != "Darwin" and ansible_pkg_mgr != "pacman" and chezmoi_check.rc != 0